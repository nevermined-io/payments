name: Build CLI Binaries (Deprecated)

# NOTE: This workflow is deprecated in favor of cli-publish.yml
# which handles building, testing, publishing to npm, and documentation updates.
# This workflow is kept for manual binary builds only.

on:
  workflow_dispatch:

jobs:
  build-tarballs:
    name: Build Tarballs
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'yarn'
          cache-dependency-path: yarn.lock

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build SDK
        run: yarn build

      - name: Install CLI dependencies
        working-directory: cli
        run: yarn install --frozen-lockfile

      - name: Build CLI
        working-directory: cli
        run: yarn build

      - name: Generate manifest
        working-directory: cli
        run: npx oclif manifest

      - name: Pack tarballs
        working-directory: cli
        run: npx oclif pack tarballs --no-xz

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cli-tarballs
          path: cli/dist/*.tar.gz
          retention-days: 30

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build-tarballs
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: cli-tarballs
          path: dist

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*.tar.gz
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## Nevermined Payments CLI v${{ github.ref_name }}

            ### Installation

            **npm (recommended):**
            ```bash
            npm install -g @nevermined-io/payments-cli
            ```

            **npx (no install):**
            ```bash
            npx @nevermined-io/payments-cli --help
            ```

            **Standalone binaries:**
            Download the appropriate tarball for your platform below and extract it.

            ### What's New
            See the release notes below for details.

            ### Documentation
            - [CLI Documentation](https://nevermined.ai/docs/cli)
            - [SDK Documentation](https://nevermined.ai/docs/payments)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
