name: Publish Documentation

on:
  push:
    tags:
      - 'v*.*.*'

  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag to publish (e.g., v1.0.2)'
        required: true
        type: string
      target_branch:
        description: 'Target branch in docs_mintlify repository (e.g., main, preview, test)'
        required: false
        type: string
        default: 'main'

jobs:
  publish-to-mintlify:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout payments repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.version || github.ref }}
          path: payments

      - name: Verify documentation exists
        run: |
          if [ ! -d "payments/markdown" ]; then
            echo "Error: markdown directory not found"
            exit 1
          fi

          # Count markdown files
          FILE_COUNT=$(find payments/markdown -name "*.mdx" | wc -l)
          echo "Found $FILE_COUNT documentation files"

          if [ "$FILE_COUNT" -lt 11 ]; then
            echo "Error: Expected at least 11 documentation files, found $FILE_COUNT"
            exit 1
          fi

          echo "âœ“ Documentation validation passed"

      - name: Checkout docs_mintlify repository
        uses: actions/checkout@v4
        with:
          repository: nevermined-io/docs_mintlify
          token: ${{ secrets.DOCS_REPO_TOKEN }}
          path: docs_mintlify
          ref: ${{ github.event.inputs.target_branch || 'main' }}

      - name: Prepare target directory
        run: |
          TARGET_DIR="docs_mintlify/docs/api-reference/typescript"

          # Create target directory if it doesn't exist
          mkdir -p "$TARGET_DIR"

          # Backup existing docs if they exist
          if [ -d "$TARGET_DIR" ] && [ "$(ls -A $TARGET_DIR)" ]; then
            BACKUP_DIR="docs_mintlify/docs/api-reference/typescript-backup-$(date +%Y%m%d-%H%M%S)"
            echo "Creating backup at $BACKUP_DIR"
            cp -r "$TARGET_DIR" "$BACKUP_DIR"
          fi

      - name: Copy documentation files
        run: |
          SOURCE_DIR="payments/markdown"
          TARGET_DIR="docs_mintlify/docs/api-reference/typescript"

          echo "Copying documentation from $SOURCE_DIR to $TARGET_DIR"

          # Remove old files
          rm -f "$TARGET_DIR"/*.mdx

          # Copy new files
          cp "$SOURCE_DIR"/*.mdx "$TARGET_DIR/"

          # Count copied files
          COPIED_COUNT=$(find "$TARGET_DIR" -name "*.mdx" | wc -l)
          echo "âœ“ Copied $COPIED_COUNT documentation files"

      - name: Get version and target info
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${{ github.ref_name }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

          TARGET_BRANCH="${{ github.event.inputs.target_branch || 'main' }}"
          echo "target_branch=$TARGET_BRANCH" >> $GITHUB_OUTPUT
          echo "Target branch: $TARGET_BRANCH"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.DOCS_REPO_TOKEN }}
          path: docs_mintlify
          branch: update-typescript-docs-${{ steps.version.outputs.version }}
          base: ${{ steps.version.outputs.target_branch }}
          delete-branch: true
          commit-message: |
            docs: update TypeScript SDK documentation for ${{ steps.version.outputs.version }}

            - Updated from nevermined-io/payments@${{ github.sha }}
            - SDK version: ${{ steps.version.outputs.version }}
            - Target branch: ${{ steps.version.outputs.target_branch }}
            - Generated documentation from tagged release
          title: 'docs: Update TypeScript SDK Documentation (${{ steps.version.outputs.version }})'
          body: |
            ## TypeScript SDK Documentation Update

            This PR updates the TypeScript SDK documentation for version `${{ steps.version.outputs.version }}`.

            ### Changes
            - âœ… Updated all 11 documentation files
            - ðŸ“¦ Source: [nevermined-io/payments@${{ github.sha }}](https://github.com/nevermined-io/payments/commit/${{ github.sha }})
            - ðŸ·ï¸ Version: `${{ steps.version.outputs.version }}`
            - ðŸŽ¯ Target Branch: `${{ steps.version.outputs.target_branch }}`

            ### Documentation Files
            - `installation.mdx`
            - `initializing-the-library.mdx`
            - `payment-plans.mdx`
            - `agents.mdx`
            - `publishing-static-resources.mdx`
            - `payments-and-balance.mdx`
            - `querying-an-agent.mdx`
            - `validation-of-requests.mdx`
            - `mcp-integration.mdx`
            - `a2a-integration.mdx`
            - `x402.mdx`

            ### Review Checklist
            - [ ] Documentation is complete and accurate
            - [ ] All code examples are valid
            - [ ] Internal links work correctly
            - [ ] Version metadata is correct

            ---
            ðŸ¤– This PR was automatically generated by the publish-docs workflow
          labels: |
            documentation
            typescript-sdk
            automated
          reviewers: |
            aitor

      - name: Create summary
        run: |
          echo "### Documentation Publication Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Source Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Target Repository**: nevermined-io/docs_mintlify" >> $GITHUB_STEP_SUMMARY
          echo "- **Target Branch**: ${{ steps.version.outputs.target_branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Target Path**: docs/api-reference/typescript/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Documentation published successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "A pull request has been created in the docs_mintlify repository." >> $GITHUB_STEP_SUMMARY
