<!DOCTYPE html><html class="default" lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>@nevermined-io/payments</title><meta name="description" content="Documentation for @nevermined-io/payments"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="assets/style.css"/><link rel="stylesheet" href="assets/highlight.css"/><script defer src="assets/main.js"></script><script async src="assets/icons.js" id="tsd-icons-script"></script><script async src="assets/search.js" id="tsd-search-script"></script><script async src="assets/navigation.js" id="tsd-nav-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search" data-base="."><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><use href="assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="index.html" class="title">@nevermined-io/payments</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><use href="assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><h2>@nevermined-io/payments</h2></div><div class="tsd-panel tsd-typography"><p><a href="https://nevermined.io"><img src="https://raw.githubusercontent.com/nevermined-io/assets/main/images/logo/banner_logo.png" alt="banner"></a></p>
<a id="md:library-for-activating-ai-agent-payments-using-the-nevermined-protocol" class="tsd-anchor"></a><h1><a href="#md:library-for-activating-ai-agent-payments-using-the-nevermined-protocol">Library for Activating AI Agent Payments Using the Nevermined Protocol</a></h1><blockquote>
<p>TypeScript SDK to interact with the Nevermined Payments Protocol<br><a href="https://nevermined.io">nevermined.io</a></p>
</blockquote>
<a id="md:motivation" class="tsd-anchor"></a><h2><a href="#md:motivation">Motivation</a></h2><p>The evolution of AI-native commerce is inevitable, but the infrastructure to support it is currently lacking. Today, AI agents require seamless, automated payment systems for individual transactions. As demand grows, these agents will scale into swarms, transacting and operating autonomously.</p>
<p>Existing solutions are designed for human use with physical money. This does not reflect the new reality, where AI Agents need to make and receive payments quickly and efficiently, without the limitations of traditional payment systems.</p>
<p>Nevermined provides a solution that seamlessly evolves from single-agent needs to complex AI economies, eliminating friction and supporting a fully autonomous, composable future for AI-driven commerce.</p>
<a id="md:what-is-the-nevermined-payments-library" class="tsd-anchor"></a><h2><a href="#md:what-is-the-nevermined-payments-library">What is the Nevermined Payments Library?</a></h2><p>The Nevermined Payments Library is a TypeScript SDK that allows AI Builders and Subscribers to make AI Agents available for querying and use by other agents or humans. It is designed to be used alongside the Nevermined protocol, which provides a decentralized infrastructure for managing AI agents and their interactions.</p>
<p>The Payments Library enables:</p>
<ul>
<li>Easy registration and discovery of AI agents and the payment plans required to access them. All agents registered in Nevermined expose their metadata in a generic way, making them searchable and discoverable for specific purposes.</li>
<li>Flexible definition of pricing options and how AI agents can be queried. This is achieved through payment plans (based on time or credits) and consumption costs (fixed per request or dynamic). All of this can be defined by the AI builder or agent during the registration process.</li>
<li>Subscribers (humans or other agents) to purchase credits that grant access to AI agent services. Payments can be made in crypto or fiat via Stripe integration. The protocol registers the payment and credits distribution settlement on-chain.</li>
<li>Agents or users with access credits to query other AI agents. Nevermined authorizes only users with sufficient balance and keeps track of their credit usage.</li>
</ul>
<p>[<img src="docs/images/nvm_hl.png" alt="banner">]</p>
<p>The library is designed for use in browser environments or as part of AI Agents:</p>
<ul>
<li>In a browser, the library provides a simple way to connect to the Nevermined protocol, allowing users to query AI Agents or publish their own.</li>
<li>As part of an AI Agent, the library allows the agent to query other agents programmatically. Additionally, agents can use the library to expose their own services and make them available to other agents or humans.</li>
</ul>
<a id="md:quickstart" class="tsd-anchor"></a><h2><a href="#md:quickstart">Quickstart</a></h2><pre><code class="language-bash"><span class="hl-0"># yarn</span><br/><span class="hl-1">yarn</span><span class="hl-2"> </span><span class="hl-3">add</span><span class="hl-2"> </span><span class="hl-3">@nevermined-io/payments</span><br/><br/><span class="hl-0"># npm</span><br/><span class="hl-1">npm</span><span class="hl-2"> </span><span class="hl-3">install</span><span class="hl-2"> </span><span class="hl-3">@nevermined-io/payments</span>
</code><button>Copy</button></pre>
<a id="md:a2a-integration-agentstoagents" class="tsd-anchor"></a><h2><a href="#md:a2a-integration-agentstoagents">A2A Integration (Agents‑to‑Agents)</a></h2><p>Nevermined Payments integrates with the A2A protocol to authorize and charge per request between agents:</p>
<ul>
<li>Discovery: publish the Agent Card at <code>/.well-known/agent.json</code>.</li>
<li>Streaming and resubscribe: set <code>capabilities.streaming: true</code> for <code>message/stream</code> and <code>tasks/resubscribe</code>.</li>
<li>Authentication: credentials travel in HTTP headers (e.g., <code>Authorization: Bearer ...</code>), not in the JSON‑RPC payload.</li>
<li>Authorization/charging: the agent emits a final event with <code>metadata.creditsUsed</code>; Nevermined validates and burns credits accordingly.</li>
</ul>
<a id="md:payment-extension-required-in-the-agent-card" class="tsd-anchor"></a><h3><a href="#md:payment-extension-required-in-the-agent-card">Payment extension required in the Agent Card</a></h3><p>Add a payment extension under <code>capabilities.extensions</code> carrying Nevermined metadata:</p>
<pre><code class="language-json"><span class="hl-2">{</span><br/><span class="hl-2">  </span><span class="hl-4">&quot;capabilities&quot;</span><span class="hl-2">: {</span><br/><span class="hl-2">    </span><span class="hl-4">&quot;streaming&quot;</span><span class="hl-2">: </span><span class="hl-5">true</span><span class="hl-2">,</span><br/><span class="hl-2">    </span><span class="hl-4">&quot;pushNotifications&quot;</span><span class="hl-2">: </span><span class="hl-5">true</span><span class="hl-2">,</span><br/><span class="hl-2">    </span><span class="hl-4">&quot;extensions&quot;</span><span class="hl-2">: [</span><br/><span class="hl-2">      {</span><br/><span class="hl-2">        </span><span class="hl-4">&quot;uri&quot;</span><span class="hl-2">: </span><span class="hl-3">&quot;urn:nevermined:payment&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">        </span><span class="hl-4">&quot;description&quot;</span><span class="hl-2">: </span><span class="hl-3">&quot;Dynamic cost per request&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">        </span><span class="hl-4">&quot;required&quot;</span><span class="hl-2">: </span><span class="hl-5">false</span><span class="hl-2">,</span><br/><span class="hl-2">        </span><span class="hl-4">&quot;params&quot;</span><span class="hl-2">: {</span><br/><span class="hl-2">          </span><span class="hl-4">&quot;paymentType&quot;</span><span class="hl-2">: </span><span class="hl-3">&quot;dynamic&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">          </span><span class="hl-4">&quot;credits&quot;</span><span class="hl-2">: </span><span class="hl-6">1</span><span class="hl-2">,</span><br/><span class="hl-2">          </span><span class="hl-4">&quot;planId&quot;</span><span class="hl-2">: </span><span class="hl-3">&quot;&lt;planId&gt;&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">          </span><span class="hl-4">&quot;agentId&quot;</span><span class="hl-2">: </span><span class="hl-3">&quot;&lt;agentId&gt;&quot;</span><br/><span class="hl-2">        }</span><br/><span class="hl-2">      }</span><br/><span class="hl-2">    ]</span><br/><span class="hl-2">  },</span><br/><span class="hl-2">  </span><span class="hl-4">&quot;url&quot;</span><span class="hl-2">: </span><span class="hl-3">&quot;https://your-agent.example.com/a2a/&quot;</span><br/><span class="hl-2">}</span>
</code><button>Copy</button></pre>
<p>Important notes:</p>
<ul>
<li>The <code>url</code> must match exactly the URL registered in Nevermined for the agent/plan.</li>
<li>The final streaming event must include <code>metadata.creditsUsed</code> with the consumed cost.</li>
</ul>
<a id="md:requirements" class="tsd-anchor"></a><h2><a href="#md:requirements">Requirements</a></h2><p>To use the Nevermined Payments Library, you need to get your Nevermined API key. You can get yours freely from the  <a href="https://nevermined.app">Nevermined App</a>.</p>
<a id="md:environments" class="tsd-anchor"></a><h3><a href="#md:environments">Environments</a></h3><ul>
<li>Public environments: <code>sandbox</code>, <code>live</code>.</li>
<li>Internal/validation: <code>staging_sandbox</code>, <code>staging_live</code>.</li>
</ul>
<p>Pick the environment that matches where your agent and plans are registered. The agent card <code>url</code> must belong to that environment.</p>
<a id="md:initialize-the-payments-library-in-the-browser" class="tsd-anchor"></a><h3><a href="#md:initialize-the-payments-library-in-the-browser">Initialize the Payments library in the Browser</a></h3><p>This is a browser only method. Here we have an example using react.
For a full example please refer to <a href="https://github.com/nevermined-io/tutorials/tree/main/payments-nextjs-example">payments-nextjs-example</a></p>
<pre><code class="language-typescript"><span class="hl-7">import</span><span class="hl-2"> { </span><span class="hl-8">useEffect</span><span class="hl-2"> } </span><span class="hl-7">from</span><span class="hl-2"> </span><span class="hl-3">&quot;react&quot;</span><span class="hl-2">;</span><br/><span class="hl-7">import</span><span class="hl-2"> { </span><span class="hl-8">Payments</span><span class="hl-2"> } </span><span class="hl-7">from</span><span class="hl-2"> </span><span class="hl-3">&quot;@nevermined-io/payments&quot;</span><span class="hl-2">;</span><br/><br/><span class="hl-7">export</span><span class="hl-2"> </span><span class="hl-7">default</span><span class="hl-2"> </span><span class="hl-5">function</span><span class="hl-2"> </span><span class="hl-1">Home</span><span class="hl-2">() {</span><br/><span class="hl-2">  </span><span class="hl-5">const</span><span class="hl-2"> </span><span class="hl-9">payments</span><span class="hl-2"> = </span><span class="hl-5">new</span><span class="hl-2"> </span><span class="hl-1">Payments</span><span class="hl-2">({</span><br/><span class="hl-2">    </span><span class="hl-8">returnUrl:</span><span class="hl-2"> </span><span class="hl-3">&quot;http://localhost:8080&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">    </span><span class="hl-8">environment:</span><span class="hl-2"> </span><span class="hl-3">&quot;staging&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">  });</span><br/><br/><span class="hl-2">  </span><span class="hl-5">const</span><span class="hl-2"> </span><span class="hl-1">onLogin</span><span class="hl-2"> = () </span><span class="hl-5">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">    </span><span class="hl-8">payments</span><span class="hl-2">.</span><span class="hl-1">connect</span><span class="hl-2">();</span><br/><span class="hl-2">  };</span><br/><br/><span class="hl-2">  </span><span class="hl-1">useEffect</span><span class="hl-2">(() </span><span class="hl-5">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">    </span><span class="hl-8">payments</span><span class="hl-2">.</span><span class="hl-1">init</span><span class="hl-2">();</span><br/><span class="hl-2">  }, []);</span><br/><br/><span class="hl-2">  </span><span class="hl-7">return</span><span class="hl-2"> (</span><br/><span class="hl-2">    &lt;</span><span class="hl-10">main</span><span class="hl-2">&gt;</span><br/><span class="hl-2">      &lt;</span><span class="hl-10">div</span><span class="hl-2">&gt;</span><br/><span class="hl-2">        &lt;</span><span class="hl-8">button</span><span class="hl-2"> </span><span class="hl-8">onClick</span><span class="hl-2">={</span><span class="hl-8">onLogin</span><span class="hl-2">}&gt;</span><span class="hl-8">Login</span><span class="hl-2">&lt;/</span><span class="hl-8">button</span><span class="hl-2">&gt;</span><br/><span class="hl-2">      &lt;/</span><span class="hl-8">div</span><span class="hl-2">&gt;</span><br/><span class="hl-2">    &lt;/</span><span class="hl-8">main</span><span class="hl-2">&gt;</span><br/><span class="hl-2">  );</span><br/><span class="hl-2">}</span>
</code><button>Copy</button></pre>
<p>The <code>init()</code> method should be called immediately after the app returns the user to <code>returnUrl</code>.</p>
<a id="md:initialize-the-payments-library-in-an-ai-agent" class="tsd-anchor"></a><h3><a href="#md:initialize-the-payments-library-in-an-ai-agent">Initialize the Payments library in an AI Agent</a></h3><pre><code class="language-typescript"><span class="hl-7">import</span><span class="hl-2"> { </span><span class="hl-8">Payments</span><span class="hl-2"> } </span><span class="hl-7">from</span><span class="hl-2"> </span><span class="hl-3">&quot;@nevermined-io/payments&quot;</span><span class="hl-2">;</span><br/><br/><span class="hl-5">const</span><span class="hl-2"> </span><span class="hl-9">payments</span><span class="hl-2"> = </span><span class="hl-8">Payments</span><span class="hl-2">.</span><span class="hl-1">getInstance</span><span class="hl-2">({</span><br/><span class="hl-2">  </span><span class="hl-8">nvmApiKey</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-8">environment:</span><span class="hl-2"> </span><span class="hl-3">&#39;testing&#39;</span><span class="hl-2"> </span><span class="hl-7">as</span><span class="hl-2"> </span><span class="hl-10">EnvironmentName</span><span class="hl-2">,</span><br/><span class="hl-2">})</span>
</code><button>Copy</button></pre>
<a id="md:create-a-payments-plan" class="tsd-anchor"></a><h3><a href="#md:create-a-payments-plan">Create a Payments Plan</a></h3><p>Once the app is initialized we can create a payment plan:</p>
<pre><code class="language-typescript"><span class="hl-5">const</span><span class="hl-2"> </span><span class="hl-9">planMetadata</span><span class="hl-2">: </span><span class="hl-10">PlanMetadata</span><span class="hl-2"> = {</span><br/><span class="hl-2">    </span><span class="hl-8">name:</span><span class="hl-2"> </span><span class="hl-3">&#39;E2E test Payments Plan&#39;</span><span class="hl-2">,</span><br/><span class="hl-2">  }</span><br/><span class="hl-5">const</span><span class="hl-2"> </span><span class="hl-9">priceConfig</span><span class="hl-2"> = </span><span class="hl-8">payments</span><span class="hl-2">.</span><span class="hl-8">plans</span><span class="hl-2">.</span><span class="hl-1">getERC20PriceConfig</span><span class="hl-2">(</span><span class="hl-6">20</span><span class="hl-5">n</span><span class="hl-2">, </span><span class="hl-9">ERC20_ADDRESS</span><span class="hl-2">, </span><span class="hl-8">builderAddress</span><span class="hl-2">)</span><br/><span class="hl-5">const</span><span class="hl-2"> </span><span class="hl-9">creditsConfig</span><span class="hl-2"> = </span><span class="hl-8">payments</span><span class="hl-2">.</span><span class="hl-8">plans</span><span class="hl-2">.</span><span class="hl-1">getFixedCreditsConfig</span><span class="hl-2">(</span><span class="hl-6">100</span><span class="hl-5">n</span><span class="hl-2">)</span><br/><span class="hl-5">const</span><span class="hl-2"> { </span><span class="hl-9">planId</span><span class="hl-2"> } = </span><span class="hl-7">await</span><span class="hl-2"> </span><span class="hl-8">payments</span><span class="hl-2">.</span><span class="hl-8">plans</span><span class="hl-2">.</span><span class="hl-1">registerCreditsPlan</span><span class="hl-2">(</span><span class="hl-8">planMetadata</span><span class="hl-2">, </span><span class="hl-8">priceConfig</span><span class="hl-2">, </span><span class="hl-8">creditsConfig</span><span class="hl-2">)</span>
</code><button>Copy</button></pre>
<p>Or register a plan limited by time:</p>
<pre><code class="language-typescript"><span class="hl-5">const</span><span class="hl-2"> </span><span class="hl-9">priceConfig</span><span class="hl-2"> = </span><span class="hl-8">payments</span><span class="hl-2">.</span><span class="hl-8">plans</span><span class="hl-2">.</span><span class="hl-1">getERC20PriceConfig</span><span class="hl-2">(</span><span class="hl-6">50</span><span class="hl-5">n</span><span class="hl-2">, </span><span class="hl-9">ERC20_ADDRESS</span><span class="hl-2">, </span><span class="hl-8">builderAddress</span><span class="hl-2">)</span><br/><span class="hl-5">const</span><span class="hl-2"> </span><span class="hl-9">expirablePlanConfig</span><span class="hl-2"> = </span><span class="hl-8">payments</span><span class="hl-2">.</span><span class="hl-8">plans</span><span class="hl-2">.</span><span class="hl-1">getExpirableDurationConfig</span><span class="hl-2">(</span><span class="hl-8">payments</span><span class="hl-2">.</span><span class="hl-8">plans</span><span class="hl-2">.</span><span class="hl-9">ONE_DAY_DURATION</span><span class="hl-2">) </span><span class="hl-0">// 1 day</span><br/><span class="hl-5">const</span><span class="hl-2"> </span><span class="hl-9">response</span><span class="hl-2"> = </span><span class="hl-7">await</span><span class="hl-2"> </span><span class="hl-8">payments</span><span class="hl-2">.</span><span class="hl-8">plans</span><span class="hl-2">.</span><span class="hl-1">registerTimePlan</span><span class="hl-2">(</span><span class="hl-8">planMetadata</span><span class="hl-2">, </span><span class="hl-8">priceConfig</span><span class="hl-2">, </span><span class="hl-8">expirablePlanConfig</span><span class="hl-2">)</span>
</code><button>Copy</button></pre>
<a id="md:create-an-ai-agentservice" class="tsd-anchor"></a><h3><a href="#md:create-an-ai-agentservice">Create an AI Agent/Service</a></h3><pre><code class="language-typescript"><span class="hl-0">// Some metadata about the agent</span><br/><span class="hl-5">const</span><span class="hl-2"> </span><span class="hl-9">agentMetadata</span><span class="hl-2"> = {</span><br/><span class="hl-2">  </span><span class="hl-8">name:</span><span class="hl-2"> </span><span class="hl-3">&#39;E2E Payments Agent&#39;</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-8">tags:</span><span class="hl-2"> [</span><span class="hl-3">&#39;test&#39;</span><span class="hl-2">],</span><br/><span class="hl-2">}</span><br/><br/><span class="hl-0">// The API that the agent will expose</span><br/><span class="hl-5">const</span><span class="hl-2"> </span><span class="hl-9">agentApi</span><span class="hl-2"> = {</span><br/><span class="hl-2">  </span><span class="hl-8">endpoints:</span><span class="hl-2"> [</span><br/><span class="hl-2">    { </span><span class="hl-3">&#39;POST&#39;</span><span class="hl-8">:</span><span class="hl-2"> </span><span class="hl-3">`https://example.com/api/v1/agents/:agentId/tasks`</span><span class="hl-2"> },</span><br/><span class="hl-2">    { </span><span class="hl-3">&#39;GET&#39;</span><span class="hl-8">:</span><span class="hl-2"> </span><span class="hl-3">`https://example.com/api/v1/agents/:agentId/tasks/invoke`</span><span class="hl-2"> }</span><br/><span class="hl-2">]}</span><br/><br/><span class="hl-0">// This is the list of payment plans that the agent will accept</span><br/><span class="hl-5">const</span><span class="hl-2"> </span><span class="hl-9">paymentPlans</span><span class="hl-2"> = [ </span><span class="hl-8">creditsPlanId</span><span class="hl-2">, </span><span class="hl-8">expirablePlanId</span><span class="hl-2"> ]</span><br/><span class="hl-5">const</span><span class="hl-2"> </span><span class="hl-9">result</span><span class="hl-2"> = </span><span class="hl-7">await</span><span class="hl-2"> </span><span class="hl-8">payments</span><span class="hl-2">.</span><span class="hl-8">agents</span><span class="hl-2">.</span><span class="hl-1">registerAgent</span><span class="hl-2">(</span><span class="hl-8">agentMetadata</span><span class="hl-2">, </span><span class="hl-8">agentApi</span><span class="hl-2">, </span><span class="hl-8">paymentPlans</span><span class="hl-2">)</span><br/>
</code><button>Copy</button></pre>
<a id="md:purchase-a-payment-plan" class="tsd-anchor"></a><h3><a href="#md:purchase-a-payment-plan">Purchase a Payment Plan</a></h3><pre><code class="language-typescript"><span class="hl-5">const</span><span class="hl-2"> </span><span class="hl-9">orderResult</span><span class="hl-2"> = </span><span class="hl-7">await</span><span class="hl-2"> </span><span class="hl-8">payments</span><span class="hl-2">.</span><span class="hl-8">plans</span><span class="hl-2">.</span><span class="hl-1">orderPlan</span><span class="hl-2">(</span><span class="hl-8">creditsPlanId</span><span class="hl-2">)</span>
</code><button>Copy</button></pre>
<p>And get the balabce of the purchased plan:</p>
<pre><code class="language-typescript"><span class="hl-5">const</span><span class="hl-2"> </span><span class="hl-9">balance</span><span class="hl-2"> = </span><span class="hl-7">await</span><span class="hl-2"> </span><span class="hl-8">payments</span><span class="hl-2">.</span><span class="hl-8">plans</span><span class="hl-2">.</span><span class="hl-1">getPlanBalance</span><span class="hl-2">(</span><span class="hl-8">creditsPlanId</span><span class="hl-2">)</span><br/><span class="hl-8">console</span><span class="hl-2">.</span><span class="hl-1">log</span><span class="hl-2">(</span><span class="hl-3">`Balance: </span><span class="hl-5">${</span><span class="hl-8">balance</span><span class="hl-5">}</span><span class="hl-3">`</span><span class="hl-2">)</span>
</code><button>Copy</button></pre>
<a id="md:query-an-ai-agent" class="tsd-anchor"></a><h3><a href="#md:query-an-ai-agent">Query an AI Agent</a></h3><p>Once the user has purchased a plan, they can query the agent:</p>
<pre><code class="language-typescript"><span class="hl-5">const</span><span class="hl-2"> </span><span class="hl-9">params</span><span class="hl-2"> = </span><span class="hl-7">await</span><span class="hl-2"> </span><span class="hl-8">payments</span><span class="hl-2">.</span><span class="hl-8">agents</span><span class="hl-2">.</span><span class="hl-1">getAgentAccessToken</span><span class="hl-2">(</span><span class="hl-8">creditsPlanId</span><span class="hl-2">, </span><span class="hl-8">agentId</span><span class="hl-2">)</span><br/><br/><span class="hl-5">const</span><span class="hl-2"> </span><span class="hl-9">agentHTTPOptions</span><span class="hl-2"> = {</span><br/><span class="hl-2">  </span><span class="hl-8">method:</span><span class="hl-2"> </span><span class="hl-3">&#39;POST&#39;</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-8">headers:</span><span class="hl-2"> {</span><br/><span class="hl-2">    </span><span class="hl-8">Accept:</span><span class="hl-2"> </span><span class="hl-3">&#39;application/json&#39;</span><span class="hl-2">,</span><br/><span class="hl-2">    </span><span class="hl-3">&#39;Content-Type&#39;</span><span class="hl-8">:</span><span class="hl-2"> </span><span class="hl-3">&#39;application/json&#39;</span><span class="hl-2">,</span><br/><span class="hl-2">    </span><span class="hl-8">Authorization:</span><span class="hl-2">  </span><span class="hl-3">`Bearer </span><span class="hl-5">${</span><span class="hl-8">params</span><span class="hl-11">.</span><span class="hl-8">accessToken</span><span class="hl-5">}</span><span class="hl-3">`</span><br/><span class="hl-2">  },</span><br/><span class="hl-2">}</span><br/><span class="hl-5">const</span><span class="hl-2"> </span><span class="hl-9">response</span><span class="hl-2"> = </span><span class="hl-7">await</span><span class="hl-2"> </span><span class="hl-1">fetch</span><span class="hl-2">(</span><span class="hl-5">new</span><span class="hl-2"> </span><span class="hl-1">URL</span><span class="hl-2">(</span><span class="hl-8">agentURL</span><span class="hl-2">), </span><span class="hl-8">agentHTTPOptions</span><span class="hl-2">)</span><br/>
</code><button>Copy</button></pre>
<a id="md:mcp-model-context-protocol" class="tsd-anchor"></a><h2><a href="#md:mcp-model-context-protocol">MCP (Model Context Protocol)</a></h2><a id="md:what-is-mcp" class="tsd-anchor"></a><h3><a href="#md:what-is-mcp">What is MCP</a></h3><ul>
<li>MCP is a protocol for LLM apps to call external tools/resources/prompts via JSON‑RPC over HTTP (plus SSE streams). Think of it as an USB-C interface for LLMs</li>
<li>MCP servers expose handlers (tools/resources/prompts) with their logical urls, such as mcp://mcp-server/tools/my-tooling. Clients send requests with <code>Authorization: Bearer &lt;token&gt;</code>, protected by Nevermined Payments Engine and receive JSON‑RPC results or errors.</li>
</ul>
<a id="md:integration-api" class="tsd-anchor"></a><h3><a href="#md:integration-api">Integration API</a></h3><p>Nevermined integration to protect MCP handlers and burn credits.</p>
<a id="md:steps" class="tsd-anchor"></a><h3><a href="#md:steps">Steps</a></h3><pre><code class="language-ts"><span class="hl-7">import</span><span class="hl-2"> { </span><span class="hl-8">Payments</span><span class="hl-2"> } </span><span class="hl-7">from</span><span class="hl-2"> </span><span class="hl-3">&#39;@nevermined-io/payments&#39;</span><br/><br/><span class="hl-0">// 1) Create Payments on the server</span><br/><span class="hl-5">const</span><span class="hl-2"> </span><span class="hl-9">payments</span><span class="hl-2"> = </span><span class="hl-8">Payments</span><span class="hl-2">.</span><span class="hl-1">getInstance</span><span class="hl-2">({ </span><span class="hl-8">nvmApiKey</span><span class="hl-2">, </span><span class="hl-8">environment</span><span class="hl-2"> })</span><br/><br/><span class="hl-0">// 2) Configure the MCP wrapper</span><br/><span class="hl-8">payments</span><span class="hl-2">.</span><span class="hl-8">mcp</span><span class="hl-2">.</span><span class="hl-1">configure</span><span class="hl-2">({ </span><span class="hl-8">agentId:</span><span class="hl-2"> </span><span class="hl-8">process</span><span class="hl-2">.</span><span class="hl-8">env</span><span class="hl-2">.</span><span class="hl-9">NVM_AGENT_ID</span><span class="hl-2">!, </span><span class="hl-8">serverName:</span><span class="hl-2"> </span><span class="hl-3">&#39;my-mcp&#39;</span><span class="hl-2"> })</span><br/><br/><span class="hl-0">// 3) Wrap your handlers (works for both high-level and low-level servers)</span><br/><span class="hl-0">// Tool</span><br/><span class="hl-5">const</span><span class="hl-2"> </span><span class="hl-1">toolHandler</span><span class="hl-2"> = </span><span class="hl-5">async</span><span class="hl-2"> ({ </span><span class="hl-8">city</span><span class="hl-2"> }: { </span><span class="hl-8">city</span><span class="hl-2">: </span><span class="hl-10">string</span><span class="hl-2"> }) </span><span class="hl-5">=&gt;</span><span class="hl-2"> ({</span><br/><span class="hl-2">  </span><span class="hl-8">content:</span><span class="hl-2"> [{ </span><span class="hl-8">type:</span><span class="hl-2"> </span><span class="hl-3">&#39;text&#39;</span><span class="hl-2">, </span><span class="hl-8">text:</span><span class="hl-2"> </span><span class="hl-3">`Weather for </span><span class="hl-5">${</span><span class="hl-8">city</span><span class="hl-5">}</span><span class="hl-3">`</span><span class="hl-2"> }],</span><br/><span class="hl-2">})</span><br/><span class="hl-5">const</span><span class="hl-2"> </span><span class="hl-9">protectedTool</span><span class="hl-2"> = </span><span class="hl-8">payments</span><span class="hl-2">.</span><span class="hl-8">mcp</span><span class="hl-2">.</span><span class="hl-1">withPaywall</span><span class="hl-2">(</span><span class="hl-8">toolHandler</span><span class="hl-2">, {</span><br/><span class="hl-2">  </span><span class="hl-8">kind:</span><span class="hl-2"> </span><span class="hl-3">&#39;tool&#39;</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-8">name:</span><span class="hl-2"> </span><span class="hl-3">&#39;weather.today&#39;</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-8">credits:</span><span class="hl-2"> </span><span class="hl-6">2</span><span class="hl-5">n</span><span class="hl-2">, </span><span class="hl-0">// or (ctx) =&gt; bigint</span><br/><span class="hl-2">})</span><br/><span class="hl-0">// High-level: server.registerTool(&#39;weather.today&#39;, config, protectedTool)</span><br/><span class="hl-0">// Low-level: const tools = new Map([[ &#39;weather.today&#39;, protectedTool ]])</span><br/><br/><span class="hl-0">// Alternative registration:</span><br/><span class="hl-5">const</span><span class="hl-2"> { </span><span class="hl-9">registerResource</span><span class="hl-2"> } = </span><span class="hl-8">payments</span><span class="hl-2">.</span><span class="hl-8">mcp</span><span class="hl-2">.</span><span class="hl-1">attach</span><span class="hl-2">(</span><span class="hl-8">server</span><span class="hl-2">)</span><br/><span class="hl-5">const</span><span class="hl-2"> </span><span class="hl-1">resourceHandler</span><span class="hl-2"> = </span><span class="hl-5">async</span><span class="hl-2"> (</span><span class="hl-8">uri</span><span class="hl-2">: </span><span class="hl-10">URL</span><span class="hl-2">, </span><span class="hl-8">vars</span><span class="hl-2">: </span><span class="hl-10">Record</span><span class="hl-2">&lt;</span><span class="hl-10">string</span><span class="hl-2">, </span><span class="hl-10">string</span><span class="hl-2"> | </span><span class="hl-10">string</span><span class="hl-2">[]&gt;) </span><span class="hl-5">=&gt;</span><span class="hl-2"> ({</span><br/><span class="hl-2">  </span><span class="hl-8">contents:</span><span class="hl-2"> [{ </span><span class="hl-8">uri:</span><span class="hl-2"> </span><span class="hl-8">uri</span><span class="hl-2">.</span><span class="hl-8">href</span><span class="hl-2">, </span><span class="hl-8">mimeType:</span><span class="hl-2"> </span><span class="hl-3">&#39;application/json&#39;</span><span class="hl-2">, </span><span class="hl-8">text:</span><span class="hl-2"> </span><span class="hl-9">JSON</span><span class="hl-2">.</span><span class="hl-1">stringify</span><span class="hl-2">({ </span><span class="hl-8">city:</span><span class="hl-2"> </span><span class="hl-8">vars</span><span class="hl-2">.</span><span class="hl-8">city</span><span class="hl-2"> }) }],</span><br/><span class="hl-2">})</span><br/><span class="hl-1">registerResource</span><span class="hl-2">(</span><span class="hl-3">&#39;weather-today&#39;</span><span class="hl-2">, </span><span class="hl-8">template</span><span class="hl-2">, </span><span class="hl-8">config</span><span class="hl-2">, </span><span class="hl-8">resourceHandler</span><span class="hl-2">, { </span><span class="hl-8">credits:</span><span class="hl-2"> </span><span class="hl-6">1</span><span class="hl-5">n</span><span class="hl-2"> })</span>
</code><button>Copy</button></pre>
<p>Notes:</p>
<ul>
<li>Low-level servers should keep their own routing tables (e.g., Maps) and call protected handlers directly, passing an <code>extra</code> object with <code>headers.Authorization</code> (e.g., <code>extra = { headers: req.headers }</code>).</li>
</ul>
<a id="md:jsonrpc-errors" class="tsd-anchor"></a><h3><a href="#md:jsonrpc-errors">JSON‑RPC errors</a></h3><ul>
<li><strong>-32003 Payment required</strong> (missing/invalid token, not a subscriber)</li>
<li><strong>-32002 Network/other</strong> (unexpected or redeem failure if <code>onRedeemError: &#39;propagate&#39;</code>)</li>
<li>Domain codes are fine (e.g., -32004 “City not found”)</li>
</ul>
<a id="md:notes" class="tsd-anchor"></a><h3><a href="#md:notes">Notes</a></h3><ul>
<li>The wrapper reads <code>Authorization</code>, calls Nevermined <code>startProcessingRequest</code>, executes the handler, and calls <code>redeemCreditsFromRequest</code>.</li>
<li><code>credits</code> can be a <code>bigint</code> or <code>(ctx) =&gt; bigint</code> with <code>{ args, result, request }</code>.</li>
<li><code>name</code> builds the logical URL <code>mcp://{serverName}/{kind}/{name}</code>.</li>
</ul>
<a id="md:license" class="tsd-anchor"></a><h2><a href="#md:license">License</a></h2><pre><code class="language-text">Copyright 2025 Nevermined AG

Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
</code><button>Copy</button></pre>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-index-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><use href="assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><h4 class="uppercase">Member Visibility</h4><form><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-private" name="private"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Private</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></form></div><div class="tsd-theme-toggle"><h4 class="uppercase">Theme</h4><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-index-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><use href="assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#md:library-for-activating-ai-agent-payments-using-the-nevermined-protocol"><span>Library for <wbr/>Activating AI <wbr/>Agent <wbr/>Payments <wbr/>Using the <wbr/>Nevermined <wbr/>Protocol</span></a><ul><li><a href="#md:motivation"><span>Motivation</span></a></li><li><a href="#md:what-is-the-nevermined-payments-library"><span>What is the <wbr/>Nevermined <wbr/>Payments <wbr/>Library?</span></a></li><li><a href="#md:quickstart"><span>Quickstart</span></a></li><li><a href="#md:a2a-integration-agentstoagents"><span>A2<wbr/>A <wbr/>Integration (<wbr/>Agents‑to‑<wbr/>Agents)</span></a></li><li><ul><li><a href="#md:payment-extension-required-in-the-agent-card"><span>Payment extension required in the <wbr/>Agent <wbr/>Card</span></a></li></ul></li><li><a href="#md:requirements"><span>Requirements</span></a></li><li><ul><li><a href="#md:environments"><span>Environments</span></a></li><li><a href="#md:initialize-the-payments-library-in-the-browser"><span>Initialize the <wbr/>Payments library in the <wbr/>Browser</span></a></li><li><a href="#md:initialize-the-payments-library-in-an-ai-agent"><span>Initialize the <wbr/>Payments library in an AI <wbr/>Agent</span></a></li><li><a href="#md:create-a-payments-plan"><span>Create a <wbr/>Payments <wbr/>Plan</span></a></li><li><a href="#md:create-an-ai-agentservice"><span>Create an AI <wbr/>Agent/<wbr/>Service</span></a></li><li><a href="#md:purchase-a-payment-plan"><span>Purchase a <wbr/>Payment <wbr/>Plan</span></a></li><li><a href="#md:query-an-ai-agent"><span>Query an AI <wbr/>Agent</span></a></li></ul></li><li><a href="#md:mcp-model-context-protocol"><span>MCP (<wbr/>Model <wbr/>Context <wbr/>Protocol)</span></a></li><li><ul><li><a href="#md:what-is-mcp"><span>What is MCP</span></a></li><li><a href="#md:integration-api"><span>Integration API</span></a></li><li><a href="#md:steps"><span>Steps</span></a></li><li><a href="#md:jsonrpc-errors"><span>JSON‑RPC errors</span></a></li><li><a href="#md:notes"><span>Notes</span></a></li></ul></li><li><a href="#md:license"><span>License</span></a></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="modules.html" class="current"><svg class="tsd-kind-icon" viewBox="0 0 24 24"><use href="assets/icons.svg#icon-1"></use></svg><span>@nevermined-io/payments</span></a><ul class="tsd-small-nested-navigation" id="tsd-nav-container" data-base="."><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>